# ------------------------------------------------------------
# 本機/容器共用設定
# - `apps/api` 會用 dotenv 讀取 `.env`
# - `docker compose` 也會自動讀取 repo root 的 `.env` 來做變數替換
# ------------------------------------------------------------

# App
APP_ENV=development

# ------------------------------------------------------------
# Docker compose：Host 端口（避免本機已佔用）
# ------------------------------------------------------------
# PostgreSQL host port（container 內固定 5432）
POSTGRES_PORT=5432
# Redis host port（container 內固定 6379）
REDIS_PORT=6379
# API host port（container 內固定 3001；Web 會呼叫這個）
API_HOST_PORT=3001
# Web host port（container 內固定 3000）
WEB_HOST_PORT=3000

# ------------------------------------------------------------
# PostgreSQL container 初始化（postgres image 會讀這三個）
# ------------------------------------------------------------
POSTGRES_USER=library
POSTGRES_PASSWORD=library
POSTGRES_DB=library_system

# ------------------------------------------------------------
# Local dev（npm run dev）用的連線字串（host=localhost）
# - 若你改了 POSTGRES_PORT / REDIS_PORT，請同步改這裡
# ------------------------------------------------------------
DATABASE_URL=postgresql://library:library@localhost:5432/library_system
REDIS_URL=redis://localhost:6379

# API 程式 listen 的 port（本機啟動 API dev server 時會用到；通常固定 3001）
API_PORT=3001

# API request body 上限（Fastify bodyLimit；避免 CSV import 在進 controller 前就 413）
# - users/bibs CSV：最大 5MB
# - authority relations CSV：最大 20MB
# - 因此預設 30MB（留 JSON overhead）
API_BODY_LIMIT_BYTES=30000000

# CORS 白名單（逗號分隔；APP_ENV=production 時必填）
# - 開發環境可留空（會採 reflect origin，提高 LAN/devcontainer DX）
CORS_ORIGINS=http://localhost:3000,http://127.0.0.1:3000

# Web dev port（目前 `apps/web` 的 dev script 固定 3000；先保留作為未來可調）
WEB_PORT=3000

# ------------------------------------------------------------
# Docker network（容器彼此連線）用的 URL
# - `docker-compose.yml` 會把這些注入到 api container
# ------------------------------------------------------------
DOCKER_DATABASE_URL=postgresql://library:library@postgres:5432/library_system
DOCKER_REDIS_URL=redis://redis:6379

# ------------------------------------------------------------
# Web：會被打包進前端的 API base（不要放 secret）
# - 若你改了 API_HOST_PORT，請同步改這個，並重新 build web
# ------------------------------------------------------------
NEXT_PUBLIC_API_BASE_URL=http://localhost:3001

# ------------------------------------------------------------
# Auth（開發用；正式環境請改成強隨機）
# ------------------------------------------------------------
AUTH_TOKEN_SECRET=dev-insecure-secret
AUTH_BOOTSTRAP_SECRET=

# 登入限流（in-memory；可用 env 調整）
# - window：固定窗（毫秒）
# - max_per_ip：同 org + 同 IP 的總嘗試上限
# - max_per_ip_user：同 org + 同 IP + 同 external_id 的嘗試上限
AUTH_LOGIN_RATE_LIMIT_WINDOW_MS=900000
AUTH_LOGIN_RATE_LIMIT_MAX_PER_IP=60
AUTH_LOGIN_RATE_LIMIT_MAX_PER_IP_USER=10
# AUTH_LOGIN_RATE_LIMIT_DISABLED=true

# ------------------------------------------------------------
# Background jobs（API in-process worker）
# - 這一版 worker 跟 API 跑在同一個 process（setInterval polling）
# - 若你不想在 dev 跑 worker，可設 JOBS_ENABLED=false
# ------------------------------------------------------------
JOBS_ENABLED=true
JOBS_POLL_INTERVAL_MS=2000

# ------------------------------------------------------------
# Scale seed（大量假資料；用於 UI 完整性驗證）
# - 匯入指令：`npm run docker:seed:scale` 或 `docker compose --profile scale run --rm seed-scale`
# - 重要：這會依 org_code 刪掉整個 org（ON DELETE CASCADE）再重建，請勿指向正式環境
# ------------------------------------------------------------
SCALE_ORG_CODE=demo-lms-scale
SCALE_ORG_NAME=示範國小（大型資料集）
SCALE_SEED=42
# 只會建立少數「可登入帳號」的 credentials（admin A0001 / librarian L0001 / teacher T0001 / student S1130123）
SCALE_PASSWORD=demo1234
# rules（預設）：不靠模型、可重現；hf：保留介面（需要網路/模型/授權策略，尚未內建）
SCALE_TEXT_PROVIDER=rules

# 量級（可依你的機器調整；預設偏「大但仍可本機跑」）
SCALE_STUDENTS=5000
SCALE_TEACHERS=200
SCALE_BIBS=4000
SCALE_MAX_COPIES_PER_BIB=3
SCALE_OPEN_LOANS=1500
SCALE_CLOSED_LOANS=12000
SCALE_READY_HOLDS=300
SCALE_QUEUED_HOLDS=800
SCALE_INVENTORY_SESSIONS=2
SCALE_SCANS_PER_SESSION=300
SCALE_AUDIT_EVENTS=5000

# seed-scale 容器內的工作目錄（產 CSV / load.sql；通常不需要改）
SCALE_WORKDIR=/tmp/seed-scale

# ------------------------------------------------------------
# E2E（Playwright；真瀏覽器 UI 測試）
# - 建議用：`npm run qa:e2e`（up + scale seed + e2e + summary）
# - 或只跑測試：`npm run docker:e2e`
# ------------------------------------------------------------
# 讓 e2e 容器寫出的檔案（report/test-results）不要變 root-owned（Linux 建議）
E2E_UID=1000
E2E_GID=1000

# 測試目標（預設對齊 scale seed）
E2E_ORG_CODE=demo-lms-scale
E2E_STAFF_EXTERNAL_ID=A0001
E2E_STAFF_PASSWORD=demo1234
E2E_PATRON_EXTERNAL_ID=S1130123
E2E_PATRON_PASSWORD=demo1234

# ------------------------------------------------------------
# Maintenance runner（例行作業；可搭配 cron / docker compose profile）
# - 指令：`npm run docker:maintenance`
# - 這會打 API 執行：
#   - holds.expire-ready（預設 apply）
#   - loans.purge-history（預設 preview；高風險刪除需手動切到 apply）
# ------------------------------------------------------------
MAINTENANCE_ORG_CODE=demo-lms-scale
MAINTENANCE_ADMIN_EXTERNAL_ID=A0001
MAINTENANCE_ADMIN_PASSWORD=demo1234

MAINTENANCE_EXPIRE_READY_MODE=apply
MAINTENANCE_EXPIRE_READY_LIMIT=200

MAINTENANCE_PURGE_HISTORY_MODE=preview
MAINTENANCE_PURGE_HISTORY_RETENTION_DAYS=365
MAINTENANCE_PURGE_HISTORY_LIMIT=500
MAINTENANCE_PURGE_HISTORY_INCLUDE_AUDIT_EVENTS=false
